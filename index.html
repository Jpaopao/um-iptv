<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UM IPTV - Player</title>
<link rel="icon" href="images/logo.png" type="image/x-icon">
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.7/shaka-player.compiled.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #000;
  }
  .container {
    display: grid;
    grid-template-columns: 350px 1fr;
    height: 100vh;
  }
  .hidden { display: none; }
  .sidebar {
    background: #111;
    color: #fff;
    overflow-y: auto;
    padding: 10px;
    border-right: 1px solid #333;
  }
  .player-container { position: relative; background: #000; }
  .player-container.fullwidth { grid-column: span 2; }
  #video { width: 100%; height: 100vh; background:#000; }
  .header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    position: sticky; top:0; background:#111; padding:10px 0; z-index:2;
  }
  #logo-circle { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; overflow: hidden; }
  #logo-circle img { width: 100%; height: 100%; object-fit: cover; }
  .hamburger {
    background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-right: 10px;
  }
  .badge { background:#e50914; color:#fff; padding:2px 6px; border-radius:4px; font-size: 12px; margin-left: auto; }
  .search { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #333; background: #000; color:#fff; }
  .category {
    margin: 14px 0 6px; font-weight: bold; color:#ddd; border-bottom:1px solid #222; padding-bottom:4px;
  }
  .channel { display: flex; align-items: center; gap: 10px; padding: 8px; cursor: pointer; border-radius: 8px; }
  .channel:hover { background: #1a1a1a; }
  .channel img.thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; }
  .ch-title { color:#fff; font-size: 14px; }
  .ch-category { color:#aaa; font-size: 12px; }
  .count { color:#888; font-size: 12px; margin: 6px 0 10px; }
</style>
</head>
<body>
  <div class="container">
    <aside class="sidebar" id="sidebar">
      <div class="header">
        <button id="hamburger" class="hamburger" aria-label="Toggle sidebar" title="Toggle sidebar">â˜°</button>
        <div id="logo-circle"><img src="images/logo.png" alt="logo"/></div>
        <div style="margin-left: 60px; font-weight: bold;">UM IPTV</div>
      </div>
      <input id="search" class="search" placeholder="Search channels..." />
      <div class="count" id="count">Channels: 0</div>
      <div id="channels"></div>
    </aside>

    <main class="player-container" id="player-container">
      <video id="video" controls autoplay playsinline muted></video>
    </main>
  </div>

<script>
// ====== DEBUG ======
const DEBUG = true;
function dlog(...a){ if (DEBUG) console.log('[UM-IPTV]', ...a); }

// ====== DOM REFS ======
const video = document.getElementById("video");
const sidebar = document.getElementById("sidebar");
const hamburger = document.getElementById("hamburger");
const playerContainer = document.getElementById("player-container");

// ====== PLAYER STATE ======
let player = null;
let hlsInstance = null;
let nowPlayingIndex = null;
let channelData = [];
let filteredChannels = [];

// ====== PROXY WRAPPER ======
function wrapWithProxy(u) {
  try {
    return /^http:\\/\\//i.test(u) ? `/api/proxy?url=${encodeURIComponent(u)}` : u;
  } catch {
    return u;
  }
}

// ====== LOAD CHANNELS ======
async function loadChannels() {
  try {
    const res = await fetch('channels.json');
    dlog('channels.json status', res.status);
    channelData = await res.json();
    dlog('channels loaded:', channelData.length);
    filteredChannels = [...channelData];
    renderChannels(filteredChannels);
    if (filteredChannels.length > 0) playChannel(filteredChannels[0], 0);
  } catch (err) {
    console.error("Failed to load channels.json", err);
  }
}

// ====== RENDER LIST ======
function renderChannels(list) {
  const container = document.getElementById("channels");
  const count = document.getElementById("count");
  container.innerHTML = "";

  // group by category
  const byCat = {};
  list.forEach(ch => {
    const key = ch.category || 'Other';
    (byCat[key] ||= []).push(ch);
  });

  Object.keys(byCat).sort().forEach(cat => {
    const h = document.createElement('div');
    h.className = 'category';
    h.textContent = cat;
    container.appendChild(h);

    byCat[cat].forEach((ch) => {
      const div = document.createElement('div');
      div.className = 'channel';

      const idx = filteredChannels.indexOf(ch);
      div.addEventListener('click', () => playChannel(ch, idx));

      const img = document.createElement('img');
      img.src = ch.thumbnail;
      img.alt = ch.name;
      img.className = 'thumb';
      div.appendChild(img);

      const meta = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'ch-title';
      title.textContent = ch.name;
      const catg = document.createElement('div');
      catg.className = 'ch-category';
      catg.textContent = ch.category;
      meta.appendChild(title);
      meta.appendChild(catg);
      div.appendChild(meta);

      if (nowPlayingIndex === idx) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = "Now Playing";
        div.appendChild(badge);
      }

      container.appendChild(div);
    });
  });

  count.textContent = `Channels: ${list.length}`;
}

// ====== PLAY CHANNEL ======
async function playChannel(ch, index) {
  if (!ch) return;
  dlog('click:', ch?.name, 'idx=', index, ch);

  nowPlayingIndex = index;
  renderChannels(filteredChannels);

  if (player) { await player.destroy().catch(() => {}); player = null; }
  if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
  video.src = "";
  video.muted = true;

  const t = (ch.type || '').toLowerCase();
  dlog('type:', t);

  if (t === "hls") {
    const src = ch.manifestUri;
    dlog('HLS load ->', src);
    if (video.canPlayType("application/vnd.apple.mpegurl")) {
      const u = wrapWithProxy(src);
      dlog('native HLS URL:', u);
      video.src = u;
      video.play().then(() => { video.muted = false; dlog('native HLS playing'); })
                  .catch(err => console.error('native HLS play err', err));
    } else if (Hls.isSupported()) {
      dlog('Hls.js supported');
      hlsInstance = new Hls({
        xhrSetup: (xhr, url) => {
          const newUrl = wrapWithProxy(url);
          dlog('Hls.js request:', url, '->', newUrl);
          xhr.open('GET', newUrl, true);
        }
      });
      hlsInstance.on(Hls.Events.ERROR, (e, data) => console.error('Hls.js error', data));
      hlsInstance.loadSource(src);
      hlsInstance.attachMedia(video);
      hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
        dlog('Hls.js manifest parsed');
        video.play().then(()=>{ video.muted = false; }).catch(err => console.error('play err', err));
      });
    } else {
      console.error("HLS not supported");
    }
    return;
  }

  if (shaka.Player.isBrowserSupported()) {
    dlog('Shaka supported');
    player = new shaka.Player(video);

    // buffering config
    player.configure({ streaming: { bufferingGoal: 15, rebufferingGoal: 10, bufferBehind: 10 }, abr: { enabled: true } });

    // proxy ALL http:// requests (manifest/segments/license)
    const net = player.getNetworkingEngine();
    net.registerRequestFilter((_type, request) => {
      if (request.uris && request.uris.length) {
        request.uris = request.uris.map(u => {
          const p = wrapWithProxy(u);
          if (DEBUG) dlog('Shaka req:', u, '->', p);
          return p;
        });
      }
    });

    // DRM config
    if (t === 'clearkey') {
      player.configure({ drm: { clearKeys: { [ch.keyId]: ch.key } } });
    } else if (t === 'dash_widevine' || t === 'widevine' || t === 'dash') {
      if (ch.licenseUrl) {
        const lic = wrapWithProxy(ch.licenseUrl);
        dlog('License URL:', lic);
        player.configure({ drm: { servers: { 'com.widevine.alpha': lic } } });
      }
    }

    const murl = wrapWithProxy(ch.manifestUri);
    dlog('Shaka load ->', murl);
    player.load(murl)
      .then(() => { dlog('Shaka loaded OK'); video.muted = false; })
      .catch(err => { console.error('Shaka load error', err); });
  } else {
    console.error('Shaka not supported in this browser');
  }
}

// ====== SEARCH ======
document.getElementById("search").addEventListener("input", (e) => {
  const q = e.target.value.toLowerCase().trim();
  filteredChannels = channelData.filter(ch =>
    ch.name.toLowerCase().includes(q) ||
    ch.category.toLowerCase().includes(q)
  );
  renderChannels(filteredChannels);
});

// ====== INIT ======
loadChannels();

// ====== SHORTCUTS ======
document.addEventListener('keydown', (e) => {
  if (e.target.tagName.toLowerCase() === 'input') return;
  if (e.key === 'ArrowDown') { const n = Math.min((nowPlayingIndex ?? 0) + 1, filteredChannels.length - 1); playChannel(filteredChannels[n], n); }
  if (e.key === 'ArrowUp')   { const n = Math.max((nowPlayingIndex ?? 0) - 1, 0); playChannel(filteredChannels[n], n); }
});

// ====== SIDEBAR TOGGLE ======
hamburger.addEventListener("click", () => {
  sidebar.classList.toggle("hidden");
  playerContainer.classList.toggle("fullwidth");
});
hamburger.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") { e.preventDefault(); hamburger.click(); }
});
</script>

</body>
</html>
